<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üì± –°–∏—Å—Ç–µ–º–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</title>
    <meta name="description" content="–ú–æ–±–∏–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            color: #333;
        }

        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            background: white;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #1e88e5 100%);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header p {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .form-container {
            padding: 15px 15px 180px 15px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .form-control:disabled {
            background: #f8f9fa;
            color: #6c757d;
            border-color: #e9ecef;
        }

        .amount-field {
            display: none;
        }

        .amount-field.show {
            display: block;
        }

        .item-field {
            display: none;
        }

        .item-field.show {
            display: block;
        }

        .action-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .btn-update {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            min-height: 56px;
        }

        .btn-update:active {
            transform: scale(0.98);
        }

        .btn-update:disabled {
            background: #6c757d;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-secondary {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            color: #667eea;
            transition: all 0.3s ease;
            min-height: 50px;
            margin-top: 10px;
        }

        .btn-secondary:active {
            transform: scale(0.98);
            background: #f8f9fa;
        }

        .status-message {
            position: fixed;
            top: 60px;
            left: 10px;
            right: 10px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
            z-index: 1000;
            transform: translateY(-80px);
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .status-message.show {
            transform: translateY(0);
            opacity: 1;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Choice Modal */
        .choice-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .choice-modal.show {
            display: flex;
        }

        .choice-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 300px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .choice-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .choice-subtitle {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-btn-primary {
            background: #667eea;
            color: white;
        }

        .choice-btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .choice-btn:active {
            transform: scale(0.98);
        }

        .choice-cancel {
            margin-top: 10px;
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>üì± –°–∏—Å—Ç–µ–º–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</h1>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é –∏ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Ç–æ–≤–∞—Ä—ã</p>
        </div>

        <!-- Main Form -->
        <div class="form-container">
            <form id="inventoryForm" autocomplete="off">
                <!-- Step 1: Shop -->
                <div class="form-group">
                    <label class="form-label" for="shop">1. –ú–∞–≥–∞–∑–∏–Ω *</label>
                    <select class="form-control" id="shop" required onchange="onShopChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
                    </select>
                </div>

                <!-- Step 2: Branch -->
                <div class="form-group">
                    <label class="form-label" for="branch">2. –§–∏–ª–∏–∞–ª *</label>
                    <select class="form-control" id="branch" required disabled>
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>
                    </select>
                </div>

                <!-- Step 3: Category -->
                <div class="form-group">
                    <label class="form-label" for="productCategory">3. –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ *</label>
                    <select class="form-control" id="productCategory" required onchange="onCategoryChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    </select>
                </div>

                <!-- Step 4: Company -->
                <div class="form-group">
                    <label class="form-label" for="company">4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å *</label>
                    <select class="form-control" id="company" required onchange="onCompanyChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</option>
                    </select>
                </div>

                <!-- Step 5a: Amount (if ALL company) -->
                <div class="form-group amount-field" id="amountField">
                    <label class="form-label" for="amount">5. –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
                    <input type="number" class="form-control" id="amount" min="0" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" autocomplete="off">
                </div>

                <!-- Step 5b: Item (if specific company) -->
                <div class="form-group item-field" id="itemField">
                    <label class="form-label" for="item">5. –¢–æ–≤–∞—Ä *</label>
                    <select class="form-control" id="item">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
                    </select>
                </div>

                <!-- Step 6: Notes (optional) -->
                <div class="form-group">
                    <label class="form-label" for="notes">6. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" class="form-control" id="notes" placeholder="–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏—è..." 
                           autocomplete="off" autocorrect="off" spellcheck="false" onfocus="scrollToNotes()">
                </div>
            </form>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Choice Modal -->
        <div id="choiceModal" class="choice-modal">
            <div class="choice-content">
                <div class="choice-title">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</div>
                <div class="choice-subtitle">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–∫–∞—á–∞—Ç—å?</div>
                
                <div class="choice-buttons">
                    <button class="choice-btn choice-btn-primary" onclick="downloadWork('branch')">
                        üìç –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª–∏–∞–ª
                    </button>
                    <button class="choice-btn choice-btn-secondary" onclick="downloadWork('day')">
                        üìÖ –í–µ—Å—å –¥–µ–Ω—å (–≤—Å–µ —Ñ–∏–ª–∏–∞–ª—ã)
                    </button>
                </div>
                
                <button class="choice-cancel" onclick="closeChoiceModal()">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>

        <!-- Bottom Action Area -->
        <div class="action-area">
            <button type="button" class="btn-update" id="updateBtn" onclick="updateInventory()" disabled>
                ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
            </button>
            
            <button type="button" class="btn-secondary" onclick="showDownloadChoice()">
                üì• –°–∫–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é —Ä–∞–±–æ—Ç—É
            </button>
        </div>
    </div>

    <script>
        // API Configuration - Use relative URLs for mobile compatibility
        const API_BASE = '/api';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            showStatus('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            try {
                await Promise.all([
                    loadShops(),
                    loadProductCategories(),
                    loadCompanies()
                ]);
                
                showStatus('‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é!', 'success');
                setTimeout(hideStatus, 2000);
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
            }
        }

        // Event Handlers
        function onShopChange() {
            const shop = document.getElementById('shop').value;
            const branchSelect = document.getElementById('branch');
            
            if (shop) {
                branchSelect.disabled = false;
                branchSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª</option>';
                loadBranchesForShop(shop);
            } else {
                branchSelect.disabled = true;
                branchSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            }
            
            checkFormComplete();
        }

        function onCategoryChange() {
            checkFormComplete();
        }

        function onCompanyChange() {
            const company = document.getElementById('company').value;
            const amountField = document.getElementById('amountField');
            const itemField = document.getElementById('itemField');
            const itemSelect = document.getElementById('item');
            
            // Reset fields
            document.getElementById('amount').value = '';
            itemSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
            
            if (company === 'ALL') {
                // Show amount field
                amountField.classList.add('show');
                itemField.classList.remove('show');
            } else if (company) {
                // Show item field and load items
                amountField.classList.remove('show');
                itemField.classList.add('show');
                loadItemsForCompany();
            } else {
                // Hide both fields
                amountField.classList.remove('show');
                itemField.classList.remove('show');
            }
            
            checkFormComplete();
        }

        // Data Loading Functions
        async function loadShops() {
            const response = await fetch(`${API_BASE}/shops`);
            const shops = await response.json();
            
            const shopSelect = document.getElementById('shop');
            shopSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω</option>';
            
            shops.forEach(shop => {
                shopSelect.innerHTML += `<option value="${shop.name}">${shop.name}</option>`;
            });
        }

        async function loadBranchesForShop(shopName) {
            try {
                const response = await fetch(`${API_BASE}/branches/${encodeURIComponent(shopName)}`);
                const branches = await response.json();
                
                const branchSelect = document.getElementById('branch');
                branchSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª</option>';
                branches.forEach(branch => {
                    branchSelect.innerHTML += `<option value="${branch}">${branch}</option>`;
                });
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤', 'error');
            }
        }

        async function loadProductCategories() {
            const response = await fetch(`${API_BASE}/product-categories`);
            const categories = await response.json();
            
            const categorySelect = document.getElementById('productCategory');
            categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
            
            categories.forEach(category => {
                categorySelect.innerHTML += `<option value="${category.name}">${category.name}</option>`;
            });
        }

        async function loadCompanies() {
            const response = await fetch(`${API_BASE}/companies`);
            const companies = await response.json();
            
            const companySelect = document.getElementById('company');
            companySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è</option>';
            
            companies.forEach(company => {
                companySelect.innerHTML += `<option value="${company.name}">${company.name}</option>`;
            });
        }

        async function loadItemsForCompany() {
            const category = document.getElementById('productCategory').value;
            const company = document.getElementById('company').value;
            
            if (!category || !company || company === 'ALL') return;
            
            try {
                const params = new URLSearchParams({
                    productCategory: category,
                    company: company
                });
                
                const response = await fetch(`${API_BASE}/items?${params}`);
                const items = await response.json();
                
                const itemSelect = document.getElementById('item');
                itemSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
                items.forEach(item => {
                    itemSelect.innerHTML += `<option value="${item}">${item}</option>`;
                });
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'error');
            }
        }

        // Form Validation
        function checkFormComplete() {
            const shop = document.getElementById('shop').value;
            const branch = document.getElementById('branch').value;
            const category = document.getElementById('productCategory').value;
            const company = document.getElementById('company').value;
            
            let isComplete = shop && branch && category && company;
            
            if (company === 'ALL') {
                const amount = document.getElementById('amount').value;
                isComplete = isComplete && amount !== '';
            } else if (company) {
                const item = document.getElementById('item').value;
                isComplete = isComplete && item;
            }
            
            document.getElementById('updateBtn').disabled = !isComplete;
        }

        // Add event listeners to all form fields
        document.addEventListener('change', checkFormComplete);
        document.addEventListener('input', checkFormComplete);

        // Form Submission
        async function updateInventory() {
            const data = {
                shop: document.getElementById('shop').value,
                branch: document.getElementById('branch').value,
                productCategory: document.getElementById('productCategory').value,
                company: document.getElementById('company').value,
                notes: document.getElementById('notes').value || null
            };
            
            if (data.company === 'ALL') {
                data.amount = parseInt(document.getElementById('amount').value);
            } else {
                data.item = document.getElementById('item').value;
            }
            
            try {
                showStatus('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...', 'info');
                
                const response = await fetch(`${API_BASE}/add-inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(`‚úÖ ${result.message}`, 'success');
                    
                    // Reset fields but keep location
                    document.getElementById('company').value = '';
                    document.getElementById('amount').value = '';
                    document.getElementById('item').value = '';
                    document.getElementById('notes').value = '';
                    document.getElementById('amountField').classList.remove('show');
                    document.getElementById('itemField').classList.remove('show');
                    
                    // Re-trigger company change to show appropriate field
                    onCompanyChange();
                    
                    checkFormComplete();
                } else {
                    showStatus(`‚ùå ${result.error}`, 'error');
                }
                
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // Show download choice modal
        function showDownloadChoice() {
            document.getElementById('choiceModal').classList.add('show');
        }

        function closeChoiceModal() {
            document.getElementById('choiceModal').classList.remove('show');
        }

        // Download work based on choice
        async function downloadWork(scope) {
            closeChoiceModal();
            
            try {
                showStatus('üì• –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Excel —Ñ–∞–π–ª–∞...', 'info');
                
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];
                
                // Build API URL with filters
                let apiUrl = `${API_BASE}/inventory-entries?limit=1000&date=${today}`;
                
                // Add branch filter if scope is 'branch'
                if (scope === 'branch') {
                    const currentShop = document.getElementById('shop').value;
                    const currentBranch = document.getElementById('branch').value;
                    
                    if (!currentShop || !currentBranch) {
                        showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –∏ —Ñ–∏–ª–∏–∞–ª', 'error');
                        return;
                    }
                    
                    // Add shop and branch filters to URL
                    apiUrl += `&shop=${encodeURIComponent(currentShop)}&branch=${encodeURIComponent(currentBranch)}`;
                }
                
                // Fetch filtered entries directly from database
                const response = await fetch(apiUrl);
                const todaysEntries = await response.json();
                
                if (!Array.isArray(todaysEntries)) {
                    showStatus('‚ùå –ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                    return;
                }
                
                if (todaysEntries.length === 0) {
                    const scopeText = scope === 'branch' ? '–ø–æ —ç—Ç–æ–º—É —Ñ–∏–ª–∏–∞–ª—É' : '';
                    showStatus(`üìù –°–µ–≥–æ–¥–Ω—è —Ä–∞–±–æ—Ç–∞ ${scopeText} –µ—â–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å`, 'info');
                    setTimeout(hideStatus, 3000);
                    return;
                }
                
                // Generate and download Excel file
                generateTodaysWorkExcel(todaysEntries, today, scope);
                
                const scopeText = scope === 'branch' ? '–ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª–∏–∞–ª—É' : '–∑–∞ –≤–µ—Å—å –¥–µ–Ω—å';
                showStatus(`üì• –°–∫–∞—á–∞–Ω–æ! ${todaysEntries.length} –∑–∞–ø–∏—Å–µ–π ${scopeText}`, 'success');
                setTimeout(hideStatus, 3000);
                
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ' + error.message, 'error');
            }
        }

        function generateTodaysWorkExcel(entries, date, scope) {
            // Excel data with Russian headers
            const headers = [
                '–í—Ä–µ–º—è', '–ú–∞–≥–∞–∑–∏–Ω', '–§–∏–ª–∏–∞–ª', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', 
                '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å', '–¢–æ–≤–∞—Ä', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–ü—Ä–∏–º–µ—á–∞–Ω–∏—è', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'
            ];
            
            // Convert entries to Excel rows
            const excelData = entries.map(entry => {
                // Time formatting from created_at
                let time = '00:00';
                
                try {
                    const entryDate = new Date(entry.entry_date);
                    
                    if (!isNaN(entryDate.getTime())) {
                        const hours = entryDate.getHours().toString().padStart(2, '0');
                        const minutes = entryDate.getMinutes().toString().padStart(2, '0');
                        time = `${hours}:${minutes}`;
                    }
                } catch (error) {
                    console.error('Error parsing date:', entry.entry_date, error);
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    time = `${hours}:${minutes}`;
                }
                
                // Item and Amount logic
                let itemValue = '';
                let amountValue = '';
                
                if (entry.company === 'ALL') {
                    // Category Total: show amount
                    amountValue = entry.amount.toString();
                } else {
                    // Individual Item: show item code and amount = 1
                    itemValue = entry.item || '';
                    amountValue = '1';
                }
                
                return [
                    time,
                    entry.shop,
                    entry.branch,
                    entry.category,
                    entry.company,
                    itemValue,     // Item column (empty for category totals)
                    amountValue,   // Amount column (1 for items, actual number for totals)
                    entry.notes || '',  // Notes column
                    entry.pic
                ];
            });
            
            // Add headers at the top
            excelData.unshift(headers);
            
            // Convert to CSV format with UTF-8 BOM for Excel compatibility
            const csvContent = excelData.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            // Add UTF-8 BOM for proper Excel encoding
            const BOM = '\uFEFF';
            const csvWithBOM = BOM + csvContent;
            
            // Create and download file with proper encoding
            const blob = new Blob([csvWithBOM], { 
                type: 'text/csv;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Create filename based on scope
            let filename;
            if (scope === 'branch') {
                const shop = entries[0]?.shop || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const branch = entries[0]?.branch || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                filename = `${shop}_${branch}_–†–∞–±–æ—Ç–∞_${date}.csv`;
            } else {
                filename = `–ú–æ—è_–†–∞–±–æ—Ç–∞_${date}.csv`;
            }
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // Status Management
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type} show`;
        }

        function hideStatus() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.classList.remove('show');
        }

        // Scroll Notes field into view when keyboard appears
        function scrollToNotes() {
            setTimeout(() => {
                const notesField = document.getElementById('notes');
                notesField.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 300); // Small delay to let keyboard appear
        }
    </script>
</body>
</html>